name: Java CI/CD with Maven

on:
  push:
    branches: [ "main" ]

env:
  APP_NAME: "todoapp"
  APP_DIR: "/opt/todoapp"
  SERVICE_NAME: "todoapp.service"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: mvn -B clean package --file pom.xml

      - name: Run tests
        run: mvn test

      - name: Verify JAR exists
        run: |
          if [ ! -f target/todoapp-0.0.1-SNAPSHOT.jar ]; then
            echo "::error::JAR file not found!"
            exit 1
          fi

      - name: Prepare remote directory
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT || '22' }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            sudo mkdir -p /opt/todoapp
            sudo chown ${{ secrets.SSH_USERNAME }}:${{ secrets.SSH_USERNAME }} /opt/todoapp
            sudo chmod 755 /opt/todoapp
            ls -ld /opt/todoapp

      - name: Copy JAR to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT || '22' }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "target/todoapp-0.0.1-SNAPSHOT.jar"
          target: "/opt/todoapp/"
          overwrite: true
          rm: false
          strip_components: 0

      - name: Verify file transfer
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT || '22' }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            ls -l /opt/todoapp/
            stat /opt/todoapp/todoapp-0.0.1-SNAPSHOT.jar

      - name: Deploy and restart service
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT || '22' }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            echo "Current JAR: $(ls -t /opt/todoapp/todoapp-*.jar | head -n 1)"
            echo "[Unit]
            Description=TodoApp Service
            After=network.target
            [Service]
            User=${{ secrets.SSH_USERNAME }}
            WorkingDirectory=/opt/todoapp
            ExecStart=/usr/bin/java -jar /opt/todoapp/todoapp-0.0.1-SNAPSHOT.jar
            SuccessExitStatus=143
            Restart=always
            RestartSec=30
            [Install]
            WantedBy=multi-user.target" | sudo tee /etc/systemd/system/todoapp.service
            sudo systemctl daemon-reload
            sudo systemctl enable todoapp.service
            sudo systemctl restart todoapp.service
            sleep 5
            systemctl status todoapp.service --no-pager

      - name: Verify deployment
        run: |
          echo "Deployment successful!"
          echo "Application should be available at: http://${{ secrets.SSH_HOST }}:8080"